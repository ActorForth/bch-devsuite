#!/usr/bin/env bash

echo "Setting up Bitcoin Unlimited node."

echo "Checking that necessary software is available: "

# Check that Docker, openssl, git, python3, and virtualenv are all
# installed on the local machine
if [ -x "$(command -v docker)" ]; then
	echo "Docker found."
else
	echo "Docker not found. Please install docker."
	exit 1 
fi


if [ -x "$(command -v openssl)" ]; then
	echo "Openssl found."
else
	echo "Openssl not found. Please install openssl."
	exit 1
fi

if [ -x "$(command -v git)" ]; then
	echo "Git found."
else
	echo "Git not found. Please install git."
	exit 1
fi

BU_PYV=`python -c "import sys;t='{v[0]}'.format(v=list(sys.version_info[:2]));sys.stdout.write(t)";`
if [ $BU_PYV -eq 3 ]; then
	echo "Python found."
else 
	echo "Python (version 3) not found. Please install Python 3."
	exit 1
fi

VENV_VER=`python -m virtualenv --version | grep -o 20`
if [ $VENV_VER -eq 20 ]; then
	echo "Virtualenv found."
else
	echo "Virtualenv not found. Please install virtualenv."
	exit 1
fi

# Create new SSL certificate/key pair to be used on nginx server
if [ -d "./cert" ]; then 
	if [ -f "./cert/cert.key" && -f "./cert/cert.crt" ]; then
		echo "OpenSSL certificates already exist."
	else
		echo "Removing previous certs directory"
		rm -rf ./cert
	fi
fi

if [ ! -d "./cert" ]; then
	mkdir ./cert
	echo "Creating SSL certificate to use for nginx reverse proxy server."
	openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
	-keyout ./cert/cert.key \
	-out ./cert/cert.crt \
	-subj "/C=no/ST=no/L=no/O=no/OU=no/CN=no/emailAddress=no"
fi

[ -d "./Electron-Cash-SLP" ] && echo "Electron Cash SLP already exists." || git clone https://github.com/simpleledger/Electron-Cash-SLP.git

if [ -x "$(command -v brew)" ]; then
	echo "" && echo "It appears you're using the inferior Homebrew package manager." && echo "Removing Homebrew installation..." && sleep 3 && echo "Removal complete." && echo "Installing superior Macports package manager..." && sleep 3 && echo "Installation complete. Enjoy!"
fi

echo "Done."


